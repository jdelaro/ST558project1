---
title: "XML Vignette"
author: "Steven Miller and Clayton Ramsey"
date: "June 4, 2019"
output: 
  html_document:
    toc: true
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# These were recommented from some resources I studied
library(XML)
library(xml2)
library(methods)
library(tidyr)
library(plyr)

# https://www.tutorialspoint.com/r/r_xml_files.htm
# https://stackoverflow.com/questions/17198658/how-to-parse-xml-to-r-data-frame
# http://www.informit.com/articles/article.aspx?p=2215520

# This is exploratory work on figuring out XML.
# d <- read_xml("death_rates.xml")
# d_list <- xmlToList(d)
# d_year <- d %>% xml_find_all("//year")
# d_df <- ldply(d_list, data.frame)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
library(ggplot2)
#library(tidyverse)
library(rmarkdown)
library(tinytex)
library(dplyr)
library(tidyr)
```  

# Description of XML data
XML stands for extensible markup language. It is a method of formatting and structuring data to be able to easily share the data online. XML data is self describing, which means that the structure of the data as well as the data are embedded in the file. Therefore, an XML file contains the metadata that describes the data in addition to the actual data, which allows for the data to be read in and stored without building the structure of the data.
Source: [TechTarget](https://searchmicroservices.techtarget.com/definition/XML-Extensible-Markup-Language)

XML is a format that can 


# XML packages and functions

# XML dataset

Our dataset is hosted at the [Centers for Disease Control and Prevention](https://data.cdc.gov/NCHS/NCHS-Death-rates-and-life-expectancy-at-birth/w9j2-ggv5
). There are 1044 observations of 5 variables: Year, Race, Sex, Average Life Expectancy, and Age-Adjusted Death Rate.

```{r setup, include=FALSE}
library("XML")

# This produces a "large list" with all the values but in a highly nested structure.
deathRatesDataXMLList <- xmlToList("death_rates.XML")
# This, we can work with.
# For example, this produces the year value from row 2:
deathRatesDataXMLList$row[[2]]$year
# This produces the mortality on row 170:
deathRatesDataXMLList$row[[170]]$mortality


# One project requirement is to write a custom function. Converting this structure to a data frame would be a reason to do that.

# The input list is l. I'm assuming it's a list formatted just like the one we produced from this XML file. The number of rows to do is n.

XML_list_to_df <- function(l, n=length(l$row)){
  if(!(is.list(l)) | !(is.numeric(n)) | n<1 | n>length(l$row)){
    return(NULL)
  }else{
    d <- data.frame("row" = 1:n) # this will be the output
    x <- character(n)
    # run through the column names...
    for(i in names(l$row[[n]])){
      # grab the values and store them to a vector
      for(j in 1:n){
        #print(as.character(l$row[[j]][i]))
        x[j] <- as.character(l$row[[j]][i])
      }
      # add that to the dataframe with the correct name
#      print(x)
      d[i] <- x
    }
  }
  d %>% tibble::as_tibble() %>% return()
}

# Here is the data frame!
deathRatesDF <- XML_list_to_df(deathRatesDataXMLList)

# deathRatesDataXML <- xmlParse(file = "C:/Users/mille/OneDrive/Documents/ST 558/Death Rates XML.xml")
# Adding the XML to the repo so that we can each access it the same way locally.

# This produces a pointer object.
# deathRatesDataXML <- XML::xmlParse(file = "death_rates.xml")

# This produces a list with pointer objects inside.
# deathRatesDataXMLRead <- read_xml("death_rates.XML")

# This line produces a single factor for each row, with all the data values crammed together.
# deathRatesDataXMLDF <- xmlToDataFrame(deathRatesDataXML) %>% t() %>% data.frame()

# deathRatesData <- tbl_df(deathRatesDataXML)
```

```{r}
# Fixing up the dataframe...
deathRateData <- deathRatesDF %>% dplyr::transmute(Year = as.integer(year),
                                                   Race = as.factor(race),
                                                    Sex = as.factor(sex),
                                             AveLifeExp = as.double(average_life_expectancy),
                                                   Mort = as.double(mortality))

```

# Exploratory data analysis
## A graph